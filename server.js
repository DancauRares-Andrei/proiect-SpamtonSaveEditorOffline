const express = require('express');
const multer = require('multer');
const path = require('path');
const fs = require('fs').promises;
const upload = multer({ storage: multer.memoryStorage() });
const app = express();
const PORT = 8080;
const ROOT_DIRECTORY = path.join(__dirname, './');

app.use(express.static(ROOT_DIRECTORY));

async function processUploadChapter1(req, res, htmlTemplateFile, outputFile) {
  try {
    const fileBuffer = req.file.buffer;
    const lines = fileBuffer.toString().split(/\r?\n/);
    if (lines.length != 10318) {
      return res.json({ err: `Not a valid Chapter 1 save file.\n Please ensure you are using the correct chapter editor. \n\n Was expecting 10318 lines, file has (${lines.length} lines.\n\nIf you believe this is an error, try loading and saving your file in-game.` });
    }
    const saveData = {

      "_1": lines[0]?.trim() || '',
      "_2": lines[1]?.trim() || '',
      "_8": lines[7]?.trim() || '',
      "_9": lines[8]?.trim() || '',
      "_10": lines[9]?.trim() || '',
      "_11": lines[10]?.trim() || '',
      "_16": lines[15]?.trim() || '',
      "_71": lines[70]?.trim() || '',
      "_72": lines[71]?.trim() || '',
      "_73": lines[72]?.trim() || '',
      "_74": lines[73]?.trim() || '',
      "_75": lines[74]?.trim() || '',
      "_77": lines[76]?.trim() || '',
      "_78": lines[77]?.trim() || '',
      "_79": lines[78]?.trim() || '',
      "_113": lines[112]?.trim() || '',
      "_114": lines[113]?.trim() || '',
      "_115": lines[114]?.trim() || '',
      "_116": lines[115]?.trim() || '',
      "_117": lines[116]?.trim() || '',
      "_118": lines[117]?.trim() || '',
      "_125": lines[124]?.trim() || '',
      "_126": lines[125]?.trim() || '',
      "_127": lines[126]?.trim() || '',
      "_128": lines[127]?.trim() || '',
      "_129": lines[128]?.trim() || '',
      "_131": lines[130]?.trim() || '',
      "_132": lines[131]?.trim() || '',
      "_133": lines[132]?.trim() || '',
      "_167": lines[166]?.trim() || '',
      "_168": lines[167]?.trim() || '',
      "_169": lines[168]?.trim() || '',
      "_170": lines[169]?.trim() || '',
      "_171": lines[170]?.trim() || '',
      "_172": lines[171]?.trim() || '',
      "_179": lines[178]?.trim() || '',
      "_180": lines[179]?.trim() || '',
      "_181": lines[180]?.trim() || '',
      "_182": lines[181]?.trim() || '',
      "_183": lines[182]?.trim() || '',
      "_185": lines[184]?.trim() || '',
      "_186": lines[185]?.trim() || '',
      "_187": lines[186]?.trim() || '',
      "_221": lines[220]?.trim() || '',
      "_222": lines[221]?.trim() || '',
      "_223": lines[222]?.trim() || '',
      "_224": lines[223]?.trim() || '',
      "_225": lines[224]?.trim() || '',
      "_226": lines[225]?.trim() || '',
      "_236": lines[235]?.trim() || '',
      "_237": lines[236]?.trim() || '',
      "_238": lines[237]?.trim() || '',
      "_239": lines[238]?.trim() || '',
      "_240": lines[239]?.trim() || '',
      "_241": lines[240]?.trim() || '',
      "_242": lines[241]?.trim() || '',
      "_243": lines[242]?.trim() || '',
      "_244": lines[243]?.trim() || '',
      "_245": lines[244]?.trim() || '',
      "_246": lines[245]?.trim() || '',
      "_247": lines[246]?.trim() || '',
      "_248": lines[247]?.trim() || '',
      "_249": lines[248]?.trim() || '',
      "_250": lines[249]?.trim() || '',
      "_251": lines[250]?.trim() || '',
      "_252": lines[251]?.trim() || '',
      "_253": lines[252]?.trim() || '',
      "_254": lines[253]?.trim() || '',
      "_255": lines[254]?.trim() || '',
      "_256": lines[255]?.trim() || '',
      "_257": lines[256]?.trim() || '',
      "_258": lines[257]?.trim() || '',
      "_259": lines[258]?.trim() || '',
      "_260": lines[259]?.trim() || '',
      "_261": lines[260]?.trim() || '',
      "_262": lines[261]?.trim() || '',
      "_263": lines[262]?.trim() || '',
      "_264": lines[263]?.trim() || '',
      "_265": lines[264]?.trim() || '',
      "_266": lines[265]?.trim() || '',
      "_267": lines[266]?.trim() || '',
      "_268": lines[267]?.trim() || '',
      "_269": lines[268]?.trim() || '',
      "_270": lines[269]?.trim() || '',
      "_271": lines[270]?.trim() || '',
      "_272": lines[271]?.trim() || '',
      "_273": lines[272]?.trim() || '',
      "_274": lines[273]?.trim() || '',
      "_275": lines[274]?.trim() || '',
      "_276": lines[275]?.trim() || '',
      "_277": lines[276]?.trim() || '',
      "_278": lines[277]?.trim() || '',
      "_279": lines[278]?.trim() || '',
      "_280": lines[279]?.trim() || '',
      "_281": lines[280]?.trim() || '',
      "_282": lines[281]?.trim() || '',
      "_283": lines[282]?.trim() || '',
      "_284": lines[283]?.trim() || '',
      "_285": lines[284]?.trim() || '',
      "_286": lines[285]?.trim() || '',
      "_287": lines[286]?.trim() || '',
      "_290": lines[289]?.trim() || '',
      "_291": lines[290]?.trim() || '',
      "_292": lines[291]?.trim() || '',
      "_293": lines[292]?.trim() || '',
      "_294": lines[293]?.trim() || '',
      "_295": lines[294]?.trim() || '',
      "_296": lines[295]?.trim() || '',
      "_297": lines[296]?.trim() || '',
      "_298": lines[297]?.trim() || '',
      "_301": lines[300]?.trim() || '',
      "_303": lines[302]?.trim() || '',
      "_305": lines[304]?.trim() || '',
      "_307": lines[306]?.trim() || '',
      "_309": lines[308]?.trim() || '',
      "_311": lines[310]?.trim() || '',
      "_313": lines[312]?.trim() || '',
      "_315": lines[314]?.trim() || '',
      "_302": lines[301]?.trim() || '',
      "_304": lines[303]?.trim() || '',
      "_306": lines[305]?.trim() || '',
      "_308": lines[307]?.trim() || '',
      "_310": lines[309]?.trim() || '',
      "_312": lines[311]?.trim() || '',
      "_314": lines[313]?.trim() || '',
      "_316": lines[315]?.trim() || '',
      "_423": lines[422]?.trim() || '',
      "_572": lines[571]?.trim() || '',
      "_573": lines[572]?.trim() || '',
      "_574": lines[573]?.trim() || '',
      "_575": lines[574]?.trim() || '',
      "_576": lines[575]?.trim() || '',
      "_577": lines[576]?.trim() || '',
      "_578": lines[577]?.trim() || '',
      "_579": lines[578]?.trim() || '',
      "_582": lines[581]?.trim() || '',
      "_586": lines[585]?.trim() || '',
      "_587": lines[586]?.trim() || '',
      "_588": lines[587]?.trim() || '',
      "_589": lines[588]?.trim() || '',
      "_590": lines[589]?.trim() || '',
      "_591": lines[590]?.trim() || '',
      "_592": lines[591]?.trim() || '',
      "_593": lines[592]?.trim() || '',
      "_594": lines[593]?.trim() || '',
      "_537": lines[536]?.trim() || '',
      "_538": lines[537]?.trim() || '',
      "_539": lines[538]?.trim() || '',
      "_540": lines[539]?.trim() || '',
      "_541": lines[540]?.trim() || '',
      "_542": lines[541]?.trim() || '',
      "_524": lines[523]?.trim() || '',
      "_1217": lines[1216]?.trim() || '',
      "_1218": lines[1217]?.trim() || '',
      "_1219": lines[1218]?.trim() || '',
      "_1220": lines[1219]?.trim() || '',
      "_1221": lines[1220]?.trim() || '',
      "_1222": lines[1221]?.trim() || '',
      "_1223": lines[1222]?.trim() || '',
      "_1224": lines[1223]?.trim() || '',
      "_1225": lines[1224]?.trim() || '',
      "_1226": lines[1225]?.trim() || '',
      "_558": lines[557]?.trim() || '',
      "_571": lines[570]?.trim() || '',
      "_1228": lines[1227]?.trim() || '',
      "_569": lines[568]?.trim() || '',
      "_570": lines[569]?.trim() || '',
      "_10316": lines[10315]?.trim() || '',
      "_10317": lines[10316]?.trim() || '',
      "_10318": lines[10317]?.trim() || '',
    };


    const htmlTemplatePath = path.join(__dirname, 'html', htmlTemplateFile);
    let htmlContent = await fs.readFile(htmlTemplatePath, 'utf8');

    htmlContent = htmlContent.replace(
      /var\s+saveData\s*=\s*\{[^}]*\};/,
      `var saveData = ${JSON.stringify(saveData)};`
    );

    const outputPath = path.join(__dirname, 'output', outputFile);
    await fs.writeFile(outputPath, htmlContent);

    res.json({ url: `/output/${outputFile}` });

  } catch (err) {
    console.error(err);
    res.json({ err: 'A apărut o eroare la procesarea fișierului.' });
  }
}
app.post('/deltarune1Demo/upload', upload.single('saveFile'), async (req, res) => {
  await processUploadChapter1(req, res, 'deltarune1DemoEdit.html', 'Gdeltarune1DemoEdit.html');
});

app.post('/deltarune1/upload', upload.single('saveFile'), async (req, res) => {
  await processUploadChapter1(req, res, 'deltarune1Edit.html', 'Gdeltarune1Edit.html');
});

async function processUploadChapter2(req, res, htmlTemplateFile, outputFile) {
    try {
    const fileBuffer = req.file.buffer;
    const lines = fileBuffer.toString().split(/\r?\n/);
    
    if (lines.length != 3055) {
      return res.json({ err: `Not a valid Chapter 1 save file.\n Please ensure you are using the correct chapter editor. \n\n Was expecting 3055 lines, file has (${lines.length} lines.\n\nIf you believe this is an error, try loading and saving your file in-game.` });
    }
    const saveData = {

      "_1": lines[0]?.trim() || '',
      "_2": lines[1]?.trim() || '',
      "_8": lines[7]?.trim() || '',
      "_9": lines[8]?.trim() || '',
      "_10": lines[9]?.trim() || '',
      "_11": lines[10]?.trim() || '',
      "_16": lines[15]?.trim() || '',
      "_79": lines[78]?.trim() || '',
      "_80": lines[79]?.trim() || '',
      "_81": lines[80]?.trim() || '',
      "_82": lines[81]?.trim() || '',
      "_83": lines[82]?.trim() || '',
      "_85": lines[84]?.trim() || '',
      "_86": lines[85]?.trim() || '',
      "_87": lines[86]?.trim() || '',
      "_129": lines[128]?.trim() || '',
      "_130": lines[129]?.trim() || '',
      "_131": lines[130]?.trim() || '',
      "_132": lines[131]?.trim() || '',
      "_133": lines[132]?.trim() || '',
      "_134": lines[133]?.trim() || '',
      "_141": lines[140]?.trim() || '',
      "_142": lines[141]?.trim() || '',
      "_143": lines[142]?.trim() || '',
      "_144": lines[143]?.trim() || '',
      "_145": lines[144]?.trim() || '',
      "_147": lines[146]?.trim() || '',
      "_148": lines[147]?.trim() || '',
      "_149": lines[148]?.trim() || '',
      "_191": lines[190]?.trim() || '',
      "_192": lines[191]?.trim() || '',
      "_193": lines[192]?.trim() || '',
      "_194": lines[193]?.trim() || '',
      "_195": lines[194]?.trim() || '',
      "_196": lines[195]?.trim() || '',
      "_203": lines[202]?.trim() || '',
      "_204": lines[203]?.trim() || '',
      "_205": lines[204]?.trim() || '',
      "_206": lines[205]?.trim() || '',
      "_207": lines[206]?.trim() || '',
      "_209": lines[208]?.trim() || '',
      "_210": lines[209]?.trim() || '',
      "_211": lines[210]?.trim() || '',
      "_253": lines[252]?.trim() || '',
      "_254": lines[253]?.trim() || '',
      "_255": lines[254]?.trim() || '',
      "_256": lines[255]?.trim() || '',
      "_257": lines[256]?.trim() || '',
      "_258": lines[257]?.trim() || '',
      "_265": lines[264]?.trim() || '',
      "_266": lines[265]?.trim() || '',
      "_267": lines[266]?.trim() || '',
      "_268": lines[267]?.trim() || '',
      "_269": lines[268]?.trim() || '',
      "_271": lines[270]?.trim() || '',
      "_272": lines[271]?.trim() || '',
      "_273": lines[272]?.trim() || '',
      "_315": lines[314]?.trim() || '',
      "_316": lines[315]?.trim() || '',
      "_317": lines[316]?.trim() || '',
      "_318": lines[317]?.trim() || '',
      "_319": lines[318]?.trim() || '',
      "_320": lines[319]?.trim() || '',
      "_330": lines[329]?.trim() || '',
      "_331": lines[330]?.trim() || '',
      "_332": lines[331]?.trim() || '',
      "_333": lines[332]?.trim() || '',
      "_334": lines[333]?.trim() || '',
      "_335": lines[334]?.trim() || '',
      "_336": lines[335]?.trim() || '',
      "_337": lines[336]?.trim() || '',
      "_338": lines[337]?.trim() || '',
      "_339": lines[338]?.trim() || '',
      "_340": lines[339]?.trim() || '',
      "_341": lines[340]?.trim() || '',
      "_342": lines[341]?.trim() || '',
      "_343": lines[342]?.trim() || '',
      "_344": lines[343]?.trim() || '',
      "_345": lines[344]?.trim() || '',
      "_346": lines[345]?.trim() || '',
      "_347": lines[346]?.trim() || '',
      "_348": lines[347]?.trim() || '',
      "_349": lines[348]?.trim() || '',
      "_350": lines[349]?.trim() || '',
      "_351": lines[350]?.trim() || '',
      "_352": lines[351]?.trim() || '',
      "_353": lines[352]?.trim() || '',
      "_356": lines[355]?.trim() || '',
      "_357": lines[356]?.trim() || '',
      "_358": lines[357]?.trim() || '',
      "_359": lines[358]?.trim() || '',
      "_360": lines[359]?.trim() || '',
      "_361": lines[360]?.trim() || '',
      "_362": lines[361]?.trim() || '',
      "_363": lines[362]?.trim() || '',
      "_364": lines[363]?.trim() || '',
      "_365": lines[364]?.trim() || '',
      "_366": lines[365]?.trim() || '',
      "_367": lines[366]?.trim() || '',
      "_368": lines[367]?.trim() || '',
      "_369": lines[368]?.trim() || '',
      "_370": lines[369]?.trim() || '',
      "_371": lines[370]?.trim() || '',
      "_372": lines[371]?.trim() || '',
      "_373": lines[372]?.trim() || '',
      "_374": lines[373]?.trim() || '',
      "_375": lines[374]?.trim() || '',
      "_376": lines[375]?.trim() || '',
      "_377": lines[376]?.trim() || '',
      "_378": lines[377]?.trim() || '',
      "_379": lines[378]?.trim() || '',
      "_380": lines[379]?.trim() || '',
      "_381": lines[380]?.trim() || '',
      "_382": lines[381]?.trim() || '',
      "_383": lines[382]?.trim() || '',
      "_384": lines[383]?.trim() || '',
      "_385": lines[384]?.trim() || '',
      "_386": lines[385]?.trim() || '',
      "_387": lines[386]?.trim() || '',
      "_388": lines[387]?.trim() || '',
      "_389": lines[388]?.trim() || '',
      "_390": lines[389]?.trim() || '',
      "_391": lines[390]?.trim() || '',
      "_392": lines[391]?.trim() || '',
      "_393": lines[392]?.trim() || '',
      "_394": lines[393]?.trim() || '',
      "_395": lines[394]?.trim() || '',
      "_396": lines[395]?.trim() || '',
      "_397": lines[396]?.trim() || '',
      "_398": lines[397]?.trim() || '',
      "_399": lines[398]?.trim() || '',
      "_400": lines[399]?.trim() || '',
      "_401": lines[400]?.trim() || '',
      "_402": lines[401]?.trim() || '',
      "_403": lines[402]?.trim() || '',
      "_404": lines[403]?.trim() || '',
      "_405": lines[404]?.trim() || '',
      "_406": lines[405]?.trim() || '',
      "_407": lines[406]?.trim() || '',
      "_408": lines[407]?.trim() || '',
      "_409": lines[408]?.trim() || '',
      "_410": lines[409]?.trim() || '',
      "_411": lines[410]?.trim() || '',
      "_412": lines[411]?.trim() || '',
      "_413": lines[412]?.trim() || '',
      "_414": lines[413]?.trim() || '',
      "_415": lines[414]?.trim() || '',
      "_416": lines[415]?.trim() || '',
      "_417": lines[416]?.trim() || '',
      "_418": lines[417]?.trim() || '',
      "_419": lines[418]?.trim() || '',
      "_420": lines[419]?.trim() || '',
      "_421": lines[420]?.trim() || '',
      "_422": lines[421]?.trim() || '',
      "_423": lines[422]?.trim() || '',
      "_424": lines[423]?.trim() || '',
      "_425": lines[424]?.trim() || '',
      "_426": lines[425]?.trim() || '',
      "_427": lines[426]?.trim() || '',
      "_428": lines[427]?.trim() || '',
      "_429": lines[428]?.trim() || '',
      "_430": lines[429]?.trim() || '',
      "_431": lines[430]?.trim() || '',
      "_432": lines[431]?.trim() || '',
      "_433": lines[432]?.trim() || '',
      "_434": lines[433]?.trim() || '',
      "_435": lines[434]?.trim() || '',
      "_436": lines[435]?.trim() || '',
      "_437": lines[436]?.trim() || '',
      "_438": lines[437]?.trim() || '',
      "_439": lines[438]?.trim() || '',
      "_440": lines[439]?.trim() || '',
      "_441": lines[440]?.trim() || '',
      "_442": lines[441]?.trim() || '',
      "_443": lines[442]?.trim() || '',
      "_444": lines[443]?.trim() || '',
      "_445": lines[444]?.trim() || '',
      "_446": lines[445]?.trim() || '',
      "_447": lines[446]?.trim() || '',
      "_448": lines[447]?.trim() || '',
      "_449": lines[448]?.trim() || '',
      "_450": lines[449]?.trim() || '',
      "_451": lines[450]?.trim() || '',
      "_452": lines[451]?.trim() || '',
      "_453": lines[452]?.trim() || '',
      "_454": lines[453]?.trim() || '',
      "_455": lines[454]?.trim() || '',
      "_456": lines[455]?.trim() || '',
      "_457": lines[456]?.trim() || '',
      "_458": lines[457]?.trim() || '',
      "_459": lines[458]?.trim() || '',
      "_460": lines[459]?.trim() || '',
      "_461": lines[460]?.trim() || '',
      "_462": lines[461]?.trim() || '',
      "_463": lines[462]?.trim() || '',
      "_464": lines[463]?.trim() || '',
      "_465": lines[464]?.trim() || '',
      "_466": lines[465]?.trim() || '',
      "_467": lines[466]?.trim() || '',
      "_468": lines[467]?.trim() || '',
      "_469": lines[468]?.trim() || '',
      "_470": lines[469]?.trim() || '',
      "_471": lines[470]?.trim() || '',
      "_472": lines[471]?.trim() || '',
      "_473": lines[472]?.trim() || '',
      "_474": lines[473]?.trim() || '',
      "_475": lines[474]?.trim() || '',
      "_526": lines[525]?.trim() || '',
      "_527": lines[526]?.trim() || '',
      "_528": lines[527]?.trim() || '',
      "_529": lines[528]?.trim() || '',
      "_530": lines[529]?.trim() || '',
      "_531": lines[530]?.trim() || '',
      "_532": lines[531]?.trim() || '',
      "_533": lines[532]?.trim() || '',
      "_534": lines[533]?.trim() || '',
      "_537": lines[536]?.trim() || '',
      "_538": lines[537]?.trim() || '',
      "_539": lines[538]?.trim() || '',
      "_540": lines[539]?.trim() || '',
      "_541": lines[540]?.trim() || '',
      "_542": lines[541]?.trim() || '',
      "_543": lines[542]?.trim() || '',
      "_544": lines[543]?.trim() || '',
      "_545": lines[544]?.trim() || '',
      "_546": lines[545]?.trim() || '',
      "_547": lines[546]?.trim() || '',
      "_548": lines[547]?.trim() || '',
      "_549": lines[548]?.trim() || '',
      "_550": lines[549]?.trim() || '',
      "_551": lines[550]?.trim() || '',
      "_552": lines[551]?.trim() || '',
      "_587": lines[586]?.trim() || '',
      "_659": lines[658]?.trim() || '',
      "_760": lines[759]?.trim() || '',
      "_773": lines[772]?.trim() || '',
      "_774": lines[773]?.trim() || '',
      "_775": lines[774]?.trim() || '',
      "_776": lines[775]?.trim() || '',
      "_777": lines[776]?.trim() || '',
      "_778": lines[777]?.trim() || '',
      "_794": lines[793]?.trim() || '',
      "_805": lines[804]?.trim() || '',
      "_806": lines[805]?.trim() || '',
      "_807": lines[806]?.trim() || '',
      "_808": lines[807]?.trim() || '',
      "_809": lines[808]?.trim() || '',
      "_810": lines[809]?.trim() || '',
      "_811": lines[810]?.trim() || '',
      "_812": lines[811]?.trim() || '',
      "_813": lines[812]?.trim() || '',
      "_814": lines[813]?.trim() || '',
      "_815": lines[814]?.trim() || '',
      "_818": lines[817]?.trim() || '',
      "_822": lines[821]?.trim() || '',
      "_823": lines[822]?.trim() || '',
      "_824": lines[823]?.trim() || '',
      "_825": lines[824]?.trim() || '',
      "_826": lines[825]?.trim() || '',
      "_827": lines[826]?.trim() || '',
      "_828": lines[827]?.trim() || '',
      "_829": lines[828]?.trim() || '',
      "_830": lines[829]?.trim() || '',
      "_855": lines[854]?.trim() || '',
      "_861": lines[860]?.trim() || '',
      "_862": lines[861]?.trim() || '',
      "_868": lines[867]?.trim() || '',
      "_869": lines[868]?.trim() || '',
      "_870": lines[869]?.trim() || '',
      "_878": lines[877]?.trim() || '',
      "_890": lines[889]?.trim() || '',
      "_894": lines[893]?.trim() || '',
      "_895": lines[894]?.trim() || '',
      "_910": lines[909]?.trim() || '',
      "_933": lines[932]?.trim() || '',
      "_975": lines[974]?.trim() || '',
      "_977": lines[976]?.trim() || '',
      "_978": lines[977]?.trim() || '',
      "_983": lines[982]?.trim() || '',
      "_992": lines[991]?.trim() || '',
      "_1010": lines[1009]?.trim() || '',
      "_1014": lines[1013]?.trim() || '',
      "_1015": lines[1014]?.trim() || '',
      "_1153": lines[1152]?.trim() || '',
      "_1154": lines[1153]?.trim() || '',
      "_1155": lines[1154]?.trim() || '',
      "_1156": lines[1155]?.trim() || '',
      "_1157": lines[1156]?.trim() || '',
      "_1158": lines[1157]?.trim() || '',
      "_1159": lines[1158]?.trim() || '',
      "_1160": lines[1159]?.trim() || '',
      "_1161": lines[1160]?.trim() || '',
      "_1162": lines[1161]?.trim() || '',
      "_1163": lines[1162]?.trim() || '',
      "_1164": lines[1163]?.trim() || '',
      "_1165": lines[1164]?.trim() || '',
      "_1166": lines[1165]?.trim() || '',
      "_1167": lines[1166]?.trim() || '',
      "_1168": lines[1167]?.trim() || '',
      "_1169": lines[1168]?.trim() || '',
      "_1170": lines[1169]?.trim() || '',
      "_1171": lines[1170]?.trim() || '',
      "_1172": lines[1171]?.trim() || '',
      "_1173": lines[1172]?.trim() || '',
      "_1174": lines[1173]?.trim() || '',
      "_1175": lines[1174]?.trim() || '',
      "_1176": lines[1175]?.trim() || '',
      "_1177": lines[1176]?.trim() || '',
      "_1178": lines[1177]?.trim() || '',
      "_1179": lines[1178]?.trim() || '',
      "_1180": lines[1179]?.trim() || '',
      "_1181": lines[1180]?.trim() || '',
      "_1182": lines[1181]?.trim() || '',
      "_1183": lines[1182]?.trim() || '',
      "_1184": lines[1183]?.trim() || '',
      "_1185": lines[1184]?.trim() || '',
      "_1186": lines[1185]?.trim() || '',
      "_1187": lines[1186]?.trim() || '',
      "_1188": lines[1187]?.trim() || '',
      "_1189": lines[1188]?.trim() || '',
      "_1190": lines[1189]?.trim() || '',
      "_1191": lines[1190]?.trim() || '',
      "_1192": lines[1191]?.trim() || '',
      "_1193": lines[1192]?.trim() || '',
      "_1194": lines[1193]?.trim() || '',
      "_1195": lines[1194]?.trim() || '',
      "_1196": lines[1195]?.trim() || '',
      "_1197": lines[1196]?.trim() || '',
      "_1198": lines[1197]?.trim() || '',
      "_1199": lines[1198]?.trim() || '',
      "_1200": lines[1199]?.trim() || '',
      "_1201": lines[1200]?.trim() || '',
      "_1202": lines[1201]?.trim() || '',
      "_1353": lines[1352]?.trim() || '',
      "_1354": lines[1353]?.trim() || '',
      "_1355": lines[1354]?.trim() || '',
      "_1356": lines[1355]?.trim() || '',
      "_1453": lines[1452]?.trim() || '',
      "_1454": lines[1453]?.trim() || '',
      "_1455": lines[1454]?.trim() || '',
      "_1456": lines[1455]?.trim() || '',
      "_1457": lines[1456]?.trim() || '',
      "_1458": lines[1457]?.trim() || '',
      "_1459": lines[1458]?.trim() || '',
      "_1460": lines[1459]?.trim() || '',
      "_1461": lines[1460]?.trim() || '',
      "_1462": lines[1461]?.trim() || '',
      "_1464": lines[1463]?.trim() || '',
      "_1468": lines[1467]?.trim() || '',
      "_1471": lines[1470]?.trim() || '',
      "_1473": lines[1472]?.trim() || '',
      "_1474": lines[1473]?.trim() || '',
      "_1475": lines[1474]?.trim() || '',
      "_1478": lines[1477]?.trim() || '',
      "_3053": lines[3052]?.trim() || '',
      "_3054": lines[3053]?.trim() || '',
      "_3055": lines[3054]?.trim() || '',
    };

    const htmlTemplatePath = path.join(__dirname, 'html', htmlTemplateFile);
    let htmlContent = await fs.readFile(htmlTemplatePath, 'utf8');

    htmlContent = htmlContent.replace(
      /var\s+saveData\s*=\s*\{[^}]*\};/,
      `var saveData = ${JSON.stringify(saveData)};`
    );

    const tempFilePath = path.join(__dirname, 'output', outputFile);
    await fs.writeFile(tempFilePath, htmlContent);

    res.json({ url: `/output/${outputFile}` });

  } catch (err) {
    console.error(err);
    res.json({ err: 'A apărut o eroare la procesarea fișierului.' });
  }
}
app.post('/deltarune2Demo/upload', upload.single('saveFile'), async (req, res) => {
  await processUploadChapter2(req, res, 'deltarune2DemoEdit.html', 'Gdeltarune2DemoEdit.html');
});

app.post('/deltarune2/upload', upload.single('saveFile'), async (req, res) => {
  await processUploadChapter2(req, res, 'deltarune2Edit.html', 'Gdeltarune2Edit.html');
});

app.post('/deltarune3/upload', upload.single('saveFile'), async (req, res) => {
     try {
    const fileBuffer = req.file.buffer;
    const lines = fileBuffer.toString().split(/\r?\n/);
    
    if (lines.length != 3055) {
      return res.json({ err: `Not a valid Chapter 1 save file.\n Please ensure you are using the correct chapter editor. \n\n Was expecting 3055 lines, file has (${lines.length} lines.\n\nIf you believe this is an error, try loading and saving your file in-game.` });
    }
    const saveData = {
      "_1": lines[0]?.trim() || '',
      "_2": lines[1]?.trim() || '',
      "_8": lines[7]?.trim() || '',
      "_9": lines[8]?.trim() || '',
      "_10": lines[9]?.trim() || '',
      "_11": lines[10]?.trim() || '',
      "_16": lines[15]?.trim() || '',
      "_79": lines[78]?.trim() || '',
      "_80": lines[79]?.trim() || '',
      "_81": lines[80]?.trim() || '',
      "_82": lines[81]?.trim() || '',
      "_83": lines[82]?.trim() || '',
      "_85": lines[84]?.trim() || '',
      "_86": lines[85]?.trim() || '',
      "_87": lines[86]?.trim() || '',
      "_129": lines[128]?.trim() || '',
      "_130": lines[129]?.trim() || '',
      "_131": lines[130]?.trim() || '',
      "_132": lines[131]?.trim() || '',
      "_133": lines[132]?.trim() || '',
      "_134": lines[133]?.trim() || '',
      "_141": lines[140]?.trim() || '',
      "_142": lines[141]?.trim() || '',
      "_143": lines[142]?.trim() || '',
      "_144": lines[143]?.trim() || '',
      "_145": lines[144]?.trim() || '',
      "_147": lines[146]?.trim() || '',
      "_148": lines[147]?.trim() || '',
      "_149": lines[148]?.trim() || '',
      "_191": lines[190]?.trim() || '',
      "_192": lines[191]?.trim() || '',
      "_193": lines[192]?.trim() || '',
      "_194": lines[193]?.trim() || '',
      "_195": lines[194]?.trim() || '',
      "_196": lines[195]?.trim() || '',
      "_203": lines[202]?.trim() || '',
      "_204": lines[203]?.trim() || '',
      "_205": lines[204]?.trim() || '',
      "_206": lines[205]?.trim() || '',
      "_207": lines[206]?.trim() || '',
      "_209": lines[208]?.trim() || '',
      "_210": lines[209]?.trim() || '',
      "_211": lines[210]?.trim() || '',
      "_253": lines[252]?.trim() || '',
      "_254": lines[253]?.trim() || '',
      "_255": lines[254]?.trim() || '',
      "_256": lines[255]?.trim() || '',
      "_257": lines[256]?.trim() || '',
      "_258": lines[257]?.trim() || '',
      "_265": lines[264]?.trim() || '',
      "_266": lines[265]?.trim() || '',
      "_267": lines[266]?.trim() || '',
      "_268": lines[267]?.trim() || '',
      "_269": lines[268]?.trim() || '',
      "_271": lines[270]?.trim() || '',
      "_272": lines[271]?.trim() || '',
      "_273": lines[272]?.trim() || '',
      "_315": lines[314]?.trim() || '',
      "_316": lines[315]?.trim() || '',
      "_317": lines[316]?.trim() || '',
      "_318": lines[317]?.trim() || '',
      "_319": lines[318]?.trim() || '',
      "_320": lines[319]?.trim() || '',
      "_330": lines[329]?.trim() || '',
      "_331": lines[330]?.trim() || '',
      "_332": lines[331]?.trim() || '',
      "_333": lines[332]?.trim() || '',
      "_334": lines[333]?.trim() || '',
      "_335": lines[334]?.trim() || '',
      "_336": lines[335]?.trim() || '',
      "_337": lines[336]?.trim() || '',
      "_338": lines[337]?.trim() || '',
      "_339": lines[338]?.trim() || '',
      "_340": lines[339]?.trim() || '',
      "_341": lines[340]?.trim() || '',
      "_342": lines[341]?.trim() || '',
      "_343": lines[342]?.trim() || '',
      "_344": lines[343]?.trim() || '',
      "_345": lines[344]?.trim() || '',
      "_346": lines[345]?.trim() || '',
      "_347": lines[346]?.trim() || '',
      "_348": lines[347]?.trim() || '',
      "_349": lines[348]?.trim() || '',
      "_350": lines[349]?.trim() || '',
      "_351": lines[350]?.trim() || '',
      "_352": lines[351]?.trim() || '',
      "_353": lines[352]?.trim() || '',
      "_356": lines[355]?.trim() || '',
      "_357": lines[356]?.trim() || '',
      "_358": lines[357]?.trim() || '',
      "_359": lines[358]?.trim() || '',
      "_360": lines[359]?.trim() || '',
      "_361": lines[360]?.trim() || '',
      "_362": lines[361]?.trim() || '',
      "_363": lines[362]?.trim() || '',
      "_364": lines[363]?.trim() || '',
      "_365": lines[364]?.trim() || '',
      "_366": lines[365]?.trim() || '',
      "_367": lines[366]?.trim() || '',
      "_368": lines[367]?.trim() || '',
      "_369": lines[368]?.trim() || '',
      "_370": lines[369]?.trim() || '',
      "_371": lines[370]?.trim() || '',
      "_372": lines[371]?.trim() || '',
      "_373": lines[372]?.trim() || '',
      "_374": lines[373]?.trim() || '',
      "_375": lines[374]?.trim() || '',
      "_376": lines[375]?.trim() || '',
      "_377": lines[376]?.trim() || '',
      "_378": lines[377]?.trim() || '',
      "_379": lines[378]?.trim() || '',
      "_380": lines[379]?.trim() || '',
      "_381": lines[380]?.trim() || '',
      "_382": lines[381]?.trim() || '',
      "_383": lines[382]?.trim() || '',
      "_384": lines[383]?.trim() || '',
      "_385": lines[384]?.trim() || '',
      "_386": lines[385]?.trim() || '',
      "_387": lines[386]?.trim() || '',
      "_388": lines[387]?.trim() || '',
      "_389": lines[388]?.trim() || '',
      "_390": lines[389]?.trim() || '',
      "_391": lines[390]?.trim() || '',
      "_392": lines[391]?.trim() || '',
      "_393": lines[392]?.trim() || '',
      "_394": lines[393]?.trim() || '',
      "_395": lines[394]?.trim() || '',
      "_396": lines[395]?.trim() || '',
      "_397": lines[396]?.trim() || '',
      "_398": lines[397]?.trim() || '',
      "_399": lines[398]?.trim() || '',
      "_400": lines[399]?.trim() || '',
      "_401": lines[400]?.trim() || '',
      "_402": lines[401]?.trim() || '',
      "_403": lines[402]?.trim() || '',
      "_404": lines[403]?.trim() || '',
      "_405": lines[404]?.trim() || '',
      "_406": lines[405]?.trim() || '',
      "_407": lines[406]?.trim() || '',
      "_408": lines[407]?.trim() || '',
      "_409": lines[408]?.trim() || '',
      "_410": lines[409]?.trim() || '',
      "_411": lines[410]?.trim() || '',
      "_412": lines[411]?.trim() || '',
      "_413": lines[412]?.trim() || '',
      "_414": lines[413]?.trim() || '',
      "_415": lines[414]?.trim() || '',
      "_416": lines[415]?.trim() || '',
      "_417": lines[416]?.trim() || '',
      "_418": lines[417]?.trim() || '',
      "_419": lines[418]?.trim() || '',
      "_420": lines[419]?.trim() || '',
      "_421": lines[420]?.trim() || '',
      "_422": lines[421]?.trim() || '',
      "_423": lines[422]?.trim() || '',
      "_424": lines[423]?.trim() || '',
      "_425": lines[424]?.trim() || '',
      "_426": lines[425]?.trim() || '',
      "_427": lines[426]?.trim() || '',
      "_428": lines[427]?.trim() || '',
      "_429": lines[428]?.trim() || '',
      "_430": lines[429]?.trim() || '',
      "_431": lines[430]?.trim() || '',
      "_432": lines[431]?.trim() || '',
      "_433": lines[432]?.trim() || '',
      "_434": lines[433]?.trim() || '',
      "_435": lines[434]?.trim() || '',
      "_436": lines[435]?.trim() || '',
      "_437": lines[436]?.trim() || '',
      "_438": lines[437]?.trim() || '',
      "_439": lines[438]?.trim() || '',
      "_440": lines[439]?.trim() || '',
      "_441": lines[440]?.trim() || '',
      "_442": lines[441]?.trim() || '',
      "_443": lines[442]?.trim() || '',
      "_444": lines[443]?.trim() || '',
      "_445": lines[444]?.trim() || '',
      "_446": lines[445]?.trim() || '',
      "_447": lines[446]?.trim() || '',
      "_448": lines[447]?.trim() || '',
      "_449": lines[448]?.trim() || '',
      "_450": lines[449]?.trim() || '',
      "_451": lines[450]?.trim() || '',
      "_452": lines[451]?.trim() || '',
      "_453": lines[452]?.trim() || '',
      "_454": lines[453]?.trim() || '',
      "_455": lines[454]?.trim() || '',
      "_456": lines[455]?.trim() || '',
      "_457": lines[456]?.trim() || '',
      "_458": lines[457]?.trim() || '',
      "_459": lines[458]?.trim() || '',
      "_460": lines[459]?.trim() || '',
      "_461": lines[460]?.trim() || '',
      "_462": lines[461]?.trim() || '',
      "_463": lines[462]?.trim() || '',
      "_464": lines[463]?.trim() || '',
      "_465": lines[464]?.trim() || '',
      "_466": lines[465]?.trim() || '',
      "_467": lines[466]?.trim() || '',
      "_468": lines[467]?.trim() || '',
      "_469": lines[468]?.trim() || '',
      "_470": lines[469]?.trim() || '',
      "_471": lines[470]?.trim() || '',
      "_472": lines[471]?.trim() || '',
      "_473": lines[472]?.trim() || '',
      "_474": lines[473]?.trim() || '',
      "_475": lines[474]?.trim() || '',
      "_526": lines[525]?.trim() || '',
      "_527": lines[526]?.trim() || '',
      "_528": lines[527]?.trim() || '',
      "_529": lines[528]?.trim() || '',
      "_530": lines[529]?.trim() || '',
      "_531": lines[530]?.trim() || '',
      "_532": lines[531]?.trim() || '',
      "_533": lines[532]?.trim() || '',
      "_534": lines[533]?.trim() || '',
      "_537": lines[536]?.trim() || '',
      "_538": lines[537]?.trim() || '',
      "_539": lines[538]?.trim() || '',
      "_540": lines[539]?.trim() || '',
      "_541": lines[540]?.trim() || '',
      "_542": lines[541]?.trim() || '',
      "_543": lines[542]?.trim() || '',
      "_544": lines[543]?.trim() || '',
      "_545": lines[544]?.trim() || '',
      "_546": lines[545]?.trim() || '',
      "_547": lines[546]?.trim() || '',
      "_548": lines[547]?.trim() || '',
      "_549": lines[548]?.trim() || '',
      "_550": lines[549]?.trim() || '',
      "_551": lines[550]?.trim() || '',
      "_552": lines[551]?.trim() || '',
      "_587": lines[586]?.trim() || '',
      "_659": lines[658]?.trim() || '',
      "_760": lines[759]?.trim() || '',
      "_773": lines[772]?.trim() || '',
      "_774": lines[773]?.trim() || '',
      "_775": lines[774]?.trim() || '',
      "_776": lines[775]?.trim() || '',
      "_777": lines[776]?.trim() || '',
      "_778": lines[777]?.trim() || '',
      "_794": lines[793]?.trim() || '',
      "_805": lines[804]?.trim() || '',
      "_806": lines[805]?.trim() || '',
      "_807": lines[806]?.trim() || '',
      "_808": lines[807]?.trim() || '',
      "_809": lines[808]?.trim() || '',
      "_810": lines[809]?.trim() || '',
      "_811": lines[810]?.trim() || '',
      "_812": lines[811]?.trim() || '',
      "_813": lines[812]?.trim() || '',
      "_814": lines[813]?.trim() || '',
      "_815": lines[814]?.trim() || '',
      "_818": lines[817]?.trim() || '',
      "_822": lines[821]?.trim() || '',
      "_823": lines[822]?.trim() || '',
      "_824": lines[823]?.trim() || '',
      "_825": lines[824]?.trim() || '',
      "_826": lines[825]?.trim() || '',
      "_827": lines[826]?.trim() || '',
      "_828": lines[827]?.trim() || '',
      "_829": lines[828]?.trim() || '',
      "_830": lines[829]?.trim() || '',
      "_855": lines[854]?.trim() || '',
      "_861": lines[860]?.trim() || '',
      "_862": lines[861]?.trim() || '',
      "_868": lines[867]?.trim() || '',
      "_869": lines[868]?.trim() || '',
      "_870": lines[869]?.trim() || '',
      "_878": lines[877]?.trim() || '',
      "_890": lines[889]?.trim() || '',
      "_894": lines[893]?.trim() || '',
      "_895": lines[894]?.trim() || '',
      "_910": lines[909]?.trim() || '',
      "_933": lines[932]?.trim() || '',
      "_975": lines[974]?.trim() || '',
      "_977": lines[976]?.trim() || '',
      "_978": lines[977]?.trim() || '',
      "_983": lines[982]?.trim() || '',
      "_992": lines[991]?.trim() || '',
      "_1010": lines[1009]?.trim() || '',
      "_1014": lines[1013]?.trim() || '',
      "_1015": lines[1014]?.trim() || '',
      "_1153": lines[1152]?.trim() || '',
      "_1154": lines[1153]?.trim() || '',
      "_1155": lines[1154]?.trim() || '',
      "_1156": lines[1155]?.trim() || '',
      "_1157": lines[1156]?.trim() || '',
      "_1158": lines[1157]?.trim() || '',
      "_1159": lines[1158]?.trim() || '',
      "_1160": lines[1159]?.trim() || '',
      "_1161": lines[1160]?.trim() || '',
      "_1162": lines[1161]?.trim() || '',
      "_1163": lines[1162]?.trim() || '',
      "_1164": lines[1163]?.trim() || '',
      "_1165": lines[1164]?.trim() || '',
      "_1166": lines[1165]?.trim() || '',
      "_1167": lines[1166]?.trim() || '',
      "_1168": lines[1167]?.trim() || '',
      "_1169": lines[1168]?.trim() || '',
      "_1170": lines[1169]?.trim() || '',
      "_1171": lines[1170]?.trim() || '',
      "_1172": lines[1171]?.trim() || '',
      "_1173": lines[1172]?.trim() || '',
      "_1174": lines[1173]?.trim() || '',
      "_1175": lines[1174]?.trim() || '',
      "_1176": lines[1175]?.trim() || '',
      "_1177": lines[1176]?.trim() || '',
      "_1178": lines[1177]?.trim() || '',
      "_1179": lines[1178]?.trim() || '',
      "_1180": lines[1179]?.trim() || '',
      "_1181": lines[1180]?.trim() || '',
      "_1182": lines[1181]?.trim() || '',
      "_1183": lines[1182]?.trim() || '',
      "_1184": lines[1183]?.trim() || '',
      "_1185": lines[1184]?.trim() || '',
      "_1186": lines[1185]?.trim() || '',
      "_1187": lines[1186]?.trim() || '',
      "_1188": lines[1187]?.trim() || '',
      "_1189": lines[1188]?.trim() || '',
      "_1190": lines[1189]?.trim() || '',
      "_1191": lines[1190]?.trim() || '',
      "_1192": lines[1191]?.trim() || '',
      "_1193": lines[1192]?.trim() || '',
      "_1194": lines[1193]?.trim() || '',
      "_1195": lines[1194]?.trim() || '',
      "_1196": lines[1195]?.trim() || '',
      "_1197": lines[1196]?.trim() || '',
      "_1198": lines[1197]?.trim() || '',
      "_1199": lines[1198]?.trim() || '',
      "_1200": lines[1199]?.trim() || '',
      "_1201": lines[1200]?.trim() || '',
      "_1202": lines[1201]?.trim() || '',
      "_1203": lines[1202]?.trim() || '',
      "_1204": lines[1203]?.trim() || '',
      "_1205": lines[1204]?.trim() || '',
      "_1206": lines[1205]?.trim() || '',
      "_1207": lines[1206]?.trim() || '',
      "_1208": lines[1207]?.trim() || '',
      "_1209": lines[1208]?.trim() || '',
      "_1210": lines[1209]?.trim() || '',
      "_1211": lines[1210]?.trim() || '',
      "_1212": lines[1211]?.trim() || '',
      "_1213": lines[1212]?.trim() || '',
      "_1214": lines[1213]?.trim() || '',
      "_1215": lines[1214]?.trim() || '',
      "_1216": lines[1215]?.trim() || '',
      "_1217": lines[1216]?.trim() || '',
      "_1218": lines[1217]?.trim() || '',
      "_1219": lines[1218]?.trim() || '',
      "_1220": lines[1219]?.trim() || '',
      "_1221": lines[1220]?.trim() || '',
      "_1222": lines[1221]?.trim() || '',
      "_1223": lines[1222]?.trim() || '',
      "_1224": lines[1223]?.trim() || '',
      "_1225": lines[1224]?.trim() || '',
      "_1226": lines[1225]?.trim() || '',
      "_1227": lines[1226]?.trim() || '',
      "_1228": lines[1227]?.trim() || '',
      "_1229": lines[1228]?.trim() || '',
      "_1330": lines[1329]?.trim() || '',
      "_1331": lines[1330]?.trim() || '',
      "_1332": lines[1331]?.trim() || '',
      "_1353": lines[1352]?.trim() || '',
      "_1354": lines[1353]?.trim() || '',
      "_1355": lines[1354]?.trim() || '',
      "_1356": lines[1355]?.trim() || '',
      "_1453": lines[1452]?.trim() || '',
      "_1454": lines[1453]?.trim() || '',
      "_1455": lines[1454]?.trim() || '',
      "_1456": lines[1455]?.trim() || '',
      "_1457": lines[1456]?.trim() || '',
      "_1458": lines[1457]?.trim() || '',
      "_1459": lines[1458]?.trim() || '',
      "_1460": lines[1459]?.trim() || '',
      "_1461": lines[1460]?.trim() || '',
      "_1462": lines[1461]?.trim() || '',
      "_1464": lines[1463]?.trim() || '',
      "_1468": lines[1467]?.trim() || '',
      "_1471": lines[1470]?.trim() || '',
      "_1473": lines[1472]?.trim() || '',
      "_1474": lines[1473]?.trim() || '',
      "_1475": lines[1474]?.trim() || '',
      "_1478": lines[1477]?.trim() || '',
      "_1597": lines[1596]?.trim() || '',
      "_3053": lines[3052]?.trim() || '',
      "_3054": lines[3053]?.trim() || '',
      "_3055": lines[3054]?.trim() || '',
    };

    const htmlTemplatePath = path.join(__dirname, 'html', 'deltarune3Edit.html');
    let htmlContent = await fs.readFile(htmlTemplatePath, 'utf8');

    htmlContent = htmlContent.replace(
      /var\s+saveData\s*=\s*\{[^}]*\};/,
      `var saveData = ${JSON.stringify(saveData)};`
    );

    const tempFilePath = path.join(__dirname, 'output', 'Gdeltarune3Edit.html');
    await fs.writeFile(tempFilePath, htmlContent);

    res.json({ url: `/output/Gdeltarune3Edit.html` });

  } catch (err) {
    console.error(err);
    res.json({ err: 'A apărut o eroare la procesarea fișierului.' });
  }
});

app.post('/deltarune4/upload', upload.single('saveFile'), async (req, res) => {
         try {
    const fileBuffer = req.file.buffer;
    const lines = fileBuffer.toString().split(/\r?\n/);
    
    if (lines.length != 3055) {
      return res.json({ err: `Not a valid Chapter 1 save file.\n Please ensure you are using the correct chapter editor. \n\n Was expecting 3055 lines, file has (${lines.length} lines.\n\nIf you believe this is an error, try loading and saving your file in-game.` });
    }
    const saveData = {

      "_1": lines[0]?.trim() || '',
      "_2": lines[1]?.trim() || '',
      "_8": lines[7]?.trim() || '',
      "_9": lines[8]?.trim() || '',
      "_10": lines[9]?.trim() || '',
      "_11": lines[10]?.trim() || '',
      "_16": lines[15]?.trim() || '',
      "_79": lines[78]?.trim() || '',
      "_80": lines[79]?.trim() || '',
      "_81": lines[80]?.trim() || '',
      "_82": lines[81]?.trim() || '',
      "_83": lines[82]?.trim() || '',
      "_85": lines[84]?.trim() || '',
      "_86": lines[85]?.trim() || '',
      "_87": lines[86]?.trim() || '',
      "_129": lines[128]?.trim() || '',
      "_130": lines[129]?.trim() || '',
      "_131": lines[130]?.trim() || '',
      "_132": lines[131]?.trim() || '',
      "_133": lines[132]?.trim() || '',
      "_134": lines[133]?.trim() || '',
      "_141": lines[140]?.trim() || '',
      "_142": lines[141]?.trim() || '',
      "_143": lines[142]?.trim() || '',
      "_144": lines[143]?.trim() || '',
      "_145": lines[144]?.trim() || '',
      "_147": lines[146]?.trim() || '',
      "_148": lines[147]?.trim() || '',
      "_149": lines[148]?.trim() || '',
      "_191": lines[190]?.trim() || '',
      "_192": lines[191]?.trim() || '',
      "_193": lines[192]?.trim() || '',
      "_194": lines[193]?.trim() || '',
      "_195": lines[194]?.trim() || '',
      "_196": lines[195]?.trim() || '',
      "_203": lines[202]?.trim() || '',
      "_204": lines[203]?.trim() || '',
      "_205": lines[204]?.trim() || '',
      "_206": lines[205]?.trim() || '',
      "_207": lines[206]?.trim() || '',
      "_209": lines[208]?.trim() || '',
      "_210": lines[209]?.trim() || '',
      "_211": lines[210]?.trim() || '',
      "_253": lines[252]?.trim() || '',
      "_254": lines[253]?.trim() || '',
      "_255": lines[254]?.trim() || '',
      "_256": lines[255]?.trim() || '',
      "_257": lines[256]?.trim() || '',
      "_258": lines[257]?.trim() || '',
      "_265": lines[264]?.trim() || '',
      "_266": lines[265]?.trim() || '',
      "_267": lines[266]?.trim() || '',
      "_268": lines[267]?.trim() || '',
      "_269": lines[268]?.trim() || '',
      "_271": lines[270]?.trim() || '',
      "_272": lines[271]?.trim() || '',
      "_273": lines[272]?.trim() || '',
      "_315": lines[314]?.trim() || '',
      "_316": lines[315]?.trim() || '',
      "_317": lines[316]?.trim() || '',
      "_318": lines[317]?.trim() || '',
      "_319": lines[318]?.trim() || '',
      "_320": lines[319]?.trim() || '',
      "_330": lines[329]?.trim() || '',
      "_331": lines[330]?.trim() || '',
      "_332": lines[331]?.trim() || '',
      "_333": lines[332]?.trim() || '',
      "_334": lines[333]?.trim() || '',
      "_335": lines[334]?.trim() || '',
      "_336": lines[335]?.trim() || '',
      "_337": lines[336]?.trim() || '',
      "_338": lines[337]?.trim() || '',
      "_339": lines[338]?.trim() || '',
      "_340": lines[339]?.trim() || '',
      "_341": lines[340]?.trim() || '',
      "_342": lines[341]?.trim() || '',
      "_343": lines[342]?.trim() || '',
      "_344": lines[343]?.trim() || '',
      "_345": lines[344]?.trim() || '',
      "_346": lines[345]?.trim() || '',
      "_347": lines[346]?.trim() || '',
      "_348": lines[347]?.trim() || '',
      "_349": lines[348]?.trim() || '',
      "_350": lines[349]?.trim() || '',
      "_351": lines[350]?.trim() || '',
      "_352": lines[351]?.trim() || '',
      "_353": lines[352]?.trim() || '',
      "_356": lines[355]?.trim() || '',
      "_357": lines[356]?.trim() || '',
      "_358": lines[357]?.trim() || '',
      "_359": lines[358]?.trim() || '',
      "_360": lines[359]?.trim() || '',
      "_361": lines[360]?.trim() || '',
      "_362": lines[361]?.trim() || '',
      "_363": lines[362]?.trim() || '',
      "_364": lines[363]?.trim() || '',
      "_365": lines[364]?.trim() || '',
      "_366": lines[365]?.trim() || '',
      "_367": lines[366]?.trim() || '',
      "_368": lines[367]?.trim() || '',
      "_369": lines[368]?.trim() || '',
      "_370": lines[369]?.trim() || '',
      "_371": lines[370]?.trim() || '',
      "_372": lines[371]?.trim() || '',
      "_373": lines[372]?.trim() || '',
      "_374": lines[373]?.trim() || '',
      "_375": lines[374]?.trim() || '',
      "_376": lines[375]?.trim() || '',
      "_377": lines[376]?.trim() || '',
      "_378": lines[377]?.trim() || '',
      "_379": lines[378]?.trim() || '',
      "_380": lines[379]?.trim() || '',
      "_381": lines[380]?.trim() || '',
      "_382": lines[381]?.trim() || '',
      "_383": lines[382]?.trim() || '',
      "_384": lines[383]?.trim() || '',
      "_385": lines[384]?.trim() || '',
      "_386": lines[385]?.trim() || '',
      "_387": lines[386]?.trim() || '',
      "_388": lines[387]?.trim() || '',
      "_389": lines[388]?.trim() || '',
      "_390": lines[389]?.trim() || '',
      "_391": lines[390]?.trim() || '',
      "_392": lines[391]?.trim() || '',
      "_393": lines[392]?.trim() || '',
      "_394": lines[393]?.trim() || '',
      "_395": lines[394]?.trim() || '',
      "_396": lines[395]?.trim() || '',
      "_397": lines[396]?.trim() || '',
      "_398": lines[397]?.trim() || '',
      "_399": lines[398]?.trim() || '',
      "_400": lines[399]?.trim() || '',
      "_401": lines[400]?.trim() || '',
      "_402": lines[401]?.trim() || '',
      "_403": lines[402]?.trim() || '',
      "_404": lines[403]?.trim() || '',
      "_405": lines[404]?.trim() || '',
      "_406": lines[405]?.trim() || '',
      "_407": lines[406]?.trim() || '',
      "_408": lines[407]?.trim() || '',
      "_409": lines[408]?.trim() || '',
      "_410": lines[409]?.trim() || '',
      "_411": lines[410]?.trim() || '',
      "_412": lines[411]?.trim() || '',
      "_413": lines[412]?.trim() || '',
      "_414": lines[413]?.trim() || '',
      "_415": lines[414]?.trim() || '',
      "_416": lines[415]?.trim() || '',
      "_417": lines[416]?.trim() || '',
      "_418": lines[417]?.trim() || '',
      "_419": lines[418]?.trim() || '',
      "_420": lines[419]?.trim() || '',
      "_421": lines[420]?.trim() || '',
      "_422": lines[421]?.trim() || '',
      "_423": lines[422]?.trim() || '',
      "_424": lines[423]?.trim() || '',
      "_425": lines[424]?.trim() || '',
      "_426": lines[425]?.trim() || '',
      "_427": lines[426]?.trim() || '',
      "_428": lines[427]?.trim() || '',
      "_429": lines[428]?.trim() || '',
      "_430": lines[429]?.trim() || '',
      "_431": lines[430]?.trim() || '',
      "_432": lines[431]?.trim() || '',
      "_433": lines[432]?.trim() || '',
      "_434": lines[433]?.trim() || '',
      "_435": lines[434]?.trim() || '',
      "_436": lines[435]?.trim() || '',
      "_437": lines[436]?.trim() || '',
      "_438": lines[437]?.trim() || '',
      "_439": lines[438]?.trim() || '',
      "_440": lines[439]?.trim() || '',
      "_441": lines[440]?.trim() || '',
      "_442": lines[441]?.trim() || '',
      "_443": lines[442]?.trim() || '',
      "_444": lines[443]?.trim() || '',
      "_445": lines[444]?.trim() || '',
      "_446": lines[445]?.trim() || '',
      "_447": lines[446]?.trim() || '',
      "_448": lines[447]?.trim() || '',
      "_449": lines[448]?.trim() || '',
      "_450": lines[449]?.trim() || '',
      "_451": lines[450]?.trim() || '',
      "_452": lines[451]?.trim() || '',
      "_453": lines[452]?.trim() || '',
      "_454": lines[453]?.trim() || '',
      "_455": lines[454]?.trim() || '',
      "_456": lines[455]?.trim() || '',
      "_457": lines[456]?.trim() || '',
      "_458": lines[457]?.trim() || '',
      "_459": lines[458]?.trim() || '',
      "_460": lines[459]?.trim() || '',
      "_461": lines[460]?.trim() || '',
      "_462": lines[461]?.trim() || '',
      "_463": lines[462]?.trim() || '',
      "_464": lines[463]?.trim() || '',
      "_465": lines[464]?.trim() || '',
      "_466": lines[465]?.trim() || '',
      "_467": lines[466]?.trim() || '',
      "_468": lines[467]?.trim() || '',
      "_469": lines[468]?.trim() || '',
      "_470": lines[469]?.trim() || '',
      "_471": lines[470]?.trim() || '',
      "_472": lines[471]?.trim() || '',
      "_473": lines[472]?.trim() || '',
      "_474": lines[473]?.trim() || '',
      "_475": lines[474]?.trim() || '',
      "_526": lines[525]?.trim() || '',
      "_527": lines[526]?.trim() || '',
      "_528": lines[527]?.trim() || '',
      "_529": lines[528]?.trim() || '',
      "_530": lines[529]?.trim() || '',
      "_531": lines[530]?.trim() || '',
      "_532": lines[531]?.trim() || '',
      "_533": lines[532]?.trim() || '',
      "_534": lines[533]?.trim() || '',
      "_537": lines[536]?.trim() || '',
      "_538": lines[537]?.trim() || '',
      "_539": lines[538]?.trim() || '',
      "_540": lines[539]?.trim() || '',
      "_541": lines[540]?.trim() || '',
      "_542": lines[541]?.trim() || '',
      "_543": lines[542]?.trim() || '',
      "_544": lines[543]?.trim() || '',
      "_545": lines[544]?.trim() || '',
      "_546": lines[545]?.trim() || '',
      "_547": lines[546]?.trim() || '',
      "_548": lines[547]?.trim() || '',
      "_549": lines[548]?.trim() || '',
      "_550": lines[549]?.trim() || '',
      "_551": lines[550]?.trim() || '',
      "_552": lines[551]?.trim() || '',
      "_587": lines[586]?.trim() || '',
      "_659": lines[658]?.trim() || '',
      "_760": lines[759]?.trim() || '',
      "_773": lines[772]?.trim() || '',
      "_774": lines[773]?.trim() || '',
      "_775": lines[774]?.trim() || '',
      "_776": lines[775]?.trim() || '',
      "_777": lines[776]?.trim() || '',
      "_778": lines[777]?.trim() || '',
      "_794": lines[793]?.trim() || '',
      "_805": lines[804]?.trim() || '',
      "_806": lines[805]?.trim() || '',
      "_807": lines[806]?.trim() || '',
      "_808": lines[807]?.trim() || '',
      "_809": lines[808]?.trim() || '',
      "_810": lines[809]?.trim() || '',
      "_811": lines[810]?.trim() || '',
      "_812": lines[811]?.trim() || '',
      "_813": lines[812]?.trim() || '',
      "_814": lines[813]?.trim() || '',
      "_815": lines[814]?.trim() || '',
      "_818": lines[817]?.trim() || '',
      "_822": lines[821]?.trim() || '',
      "_823": lines[822]?.trim() || '',
      "_824": lines[823]?.trim() || '',
      "_825": lines[824]?.trim() || '',
      "_826": lines[825]?.trim() || '',
      "_827": lines[826]?.trim() || '',
      "_828": lines[827]?.trim() || '',
      "_829": lines[828]?.trim() || '',
      "_830": lines[829]?.trim() || '',
      "_855": lines[854]?.trim() || '',
      "_861": lines[860]?.trim() || '',
      "_862": lines[861]?.trim() || '',
      "_868": lines[867]?.trim() || '',
      "_869": lines[868]?.trim() || '',
      "_870": lines[869]?.trim() || '',
      "_878": lines[877]?.trim() || '',
      "_890": lines[889]?.trim() || '',
      "_894": lines[893]?.trim() || '',
      "_895": lines[894]?.trim() || '',
      "_910": lines[909]?.trim() || '',
      "_933": lines[932]?.trim() || '',
      "_975": lines[974]?.trim() || '',
      "_977": lines[976]?.trim() || '',
      "_978": lines[977]?.trim() || '',
      "_983": lines[982]?.trim() || '',
      "_992": lines[991]?.trim() || '',
      "_1010": lines[1009]?.trim() || '',
      "_1014": lines[1013]?.trim() || '',
      "_1015": lines[1014]?.trim() || '',
      "_1153": lines[1152]?.trim() || '',
      "_1154": lines[1153]?.trim() || '',
      "_1155": lines[1154]?.trim() || '',
      "_1156": lines[1155]?.trim() || '',
      "_1157": lines[1156]?.trim() || '',
      "_1158": lines[1157]?.trim() || '',
      "_1159": lines[1158]?.trim() || '',
      "_1160": lines[1159]?.trim() || '',
      "_1161": lines[1160]?.trim() || '',
      "_1162": lines[1161]?.trim() || '',
      "_1163": lines[1162]?.trim() || '',
      "_1164": lines[1163]?.trim() || '',
      "_1165": lines[1164]?.trim() || '',
      "_1166": lines[1165]?.trim() || '',
      "_1167": lines[1166]?.trim() || '',
      "_1168": lines[1167]?.trim() || '',
      "_1169": lines[1168]?.trim() || '',
      "_1170": lines[1169]?.trim() || '',
      "_1171": lines[1170]?.trim() || '',
      "_1172": lines[1171]?.trim() || '',
      "_1173": lines[1172]?.trim() || '',
      "_1174": lines[1173]?.trim() || '',
      "_1175": lines[1174]?.trim() || '',
      "_1176": lines[1175]?.trim() || '',
      "_1177": lines[1176]?.trim() || '',
      "_1178": lines[1177]?.trim() || '',
      "_1179": lines[1178]?.trim() || '',
      "_1180": lines[1179]?.trim() || '',
      "_1181": lines[1180]?.trim() || '',
      "_1182": lines[1181]?.trim() || '',
      "_1183": lines[1182]?.trim() || '',
      "_1184": lines[1183]?.trim() || '',
      "_1185": lines[1184]?.trim() || '',
      "_1186": lines[1185]?.trim() || '',
      "_1187": lines[1186]?.trim() || '',
      "_1188": lines[1187]?.trim() || '',
      "_1189": lines[1188]?.trim() || '',
      "_1190": lines[1189]?.trim() || '',
      "_1191": lines[1190]?.trim() || '',
      "_1192": lines[1191]?.trim() || '',
      "_1193": lines[1192]?.trim() || '',
      "_1194": lines[1193]?.trim() || '',
      "_1195": lines[1194]?.trim() || '',
      "_1196": lines[1195]?.trim() || '',
      "_1197": lines[1196]?.trim() || '',
      "_1198": lines[1197]?.trim() || '',
      "_1199": lines[1198]?.trim() || '',
      "_1200": lines[1199]?.trim() || '',
      "_1201": lines[1200]?.trim() || '',
      "_1202": lines[1201]?.trim() || '',
      "_1203": lines[1202]?.trim() || '',
      "_1204": lines[1203]?.trim() || '',
      "_1205": lines[1204]?.trim() || '',
      "_1206": lines[1205]?.trim() || '',
      "_1207": lines[1206]?.trim() || '',
      "_1208": lines[1207]?.trim() || '',
      "_1209": lines[1208]?.trim() || '',
      "_1210": lines[1209]?.trim() || '',
      "_1211": lines[1210]?.trim() || '',
      "_1212": lines[1211]?.trim() || '',
      "_1213": lines[1212]?.trim() || '',
      "_1214": lines[1213]?.trim() || '',
      "_1215": lines[1214]?.trim() || '',
      "_1216": lines[1215]?.trim() || '',
      "_1217": lines[1216]?.trim() || '',
      "_1218": lines[1217]?.trim() || '',
      "_1219": lines[1218]?.trim() || '',
      "_1220": lines[1219]?.trim() || '',
      "_1221": lines[1220]?.trim() || '',
      "_1222": lines[1221]?.trim() || '',
      "_1223": lines[1222]?.trim() || '',
      "_1224": lines[1223]?.trim() || '',
      "_1225": lines[1224]?.trim() || '',
      "_1226": lines[1225]?.trim() || '',
      "_1227": lines[1226]?.trim() || '',
      "_1228": lines[1227]?.trim() || '',
      "_1229": lines[1228]?.trim() || '',
      "_1330": lines[1329]?.trim() || '',
      "_1331": lines[1330]?.trim() || '',
      "_1332": lines[1331]?.trim() || '',
      "_1353": lines[1352]?.trim() || '',
      "_1354": lines[1353]?.trim() || '',
      "_1355": lines[1354]?.trim() || '',
      "_1356": lines[1355]?.trim() || '',
      "_1453": lines[1452]?.trim() || '',
      "_1454": lines[1453]?.trim() || '',
      "_1455": lines[1454]?.trim() || '',
      "_1456": lines[1455]?.trim() || '',
      "_1457": lines[1456]?.trim() || '',
      "_1458": lines[1457]?.trim() || '',
      "_1459": lines[1458]?.trim() || '',
      "_1460": lines[1459]?.trim() || '',
      "_1461": lines[1460]?.trim() || '',
      "_1462": lines[1461]?.trim() || '',
      "_1464": lines[1463]?.trim() || '',
      "_1468": lines[1467]?.trim() || '',
      "_1471": lines[1470]?.trim() || '',
      "_1473": lines[1472]?.trim() || '',
      "_1474": lines[1473]?.trim() || '',
      "_1475": lines[1474]?.trim() || '',
      "_1478": lines[1477]?.trim() || '',
      "_3053": lines[3052]?.trim() || '',
      "_3054": lines[3053]?.trim() || '',
      "_3055": lines[3054]?.trim() || '',
    };

    const htmlTemplatePath = path.join(__dirname, 'html', 'deltarune4Edit.html');
    let htmlContent = await fs.readFile(htmlTemplatePath, 'utf8');

    htmlContent = htmlContent.replace(
      /var\s+saveData\s*=\s*\{[^}]*\};/,
      `var saveData = ${JSON.stringify(saveData)};`
    );

    const tempFilePath = path.join(__dirname, 'output', 'Gdeltarune4Edit.html');
    await fs.writeFile(tempFilePath, htmlContent);

    res.json({ url: `/output/Gdeltarune4Edit.html` });

  } catch (err) {
    console.error(err);
    res.json({ err: 'A apărut o eroare la procesarea fișierului.' });
  }
});

app.use(express.urlencoded({ extended: true }));

async function handleSavefileUpdate(req, res, inputFilename, mode) {
  try {
    const ROOT_DIRECTORY = __dirname;
    const inputPath = path.join(ROOT_DIRECTORY, 'defaultSaves', mode, inputFilename);
    const outputPath = path.join(ROOT_DIRECTORY, 'output', inputFilename);

    try {
      await fs.access(inputPath);
    } catch {
      return res.status(500).send(`Fișierul original ${inputFilename} (${mode}) nu există.`);
    }

    const lines = (await fs.readFile(inputPath, 'utf8')).split(/\r?\n/);

    for (const key in req.body) {
      if (key.startsWith('_')) {
        const index = parseInt(key.slice(1)) - 1;
        const value = req.body[key];
        if (!isNaN(index) && index >= 0 && index < lines.length) {
          lines[index] = value;
        }
      }
    }

    await fs.writeFile(outputPath, lines.join('\n'), 'utf8');

    return res.json({ url: `/output/${inputFilename}` });

  } catch (err) {
    console.error(err);
    return res.status(500).send('Eroare internă la procesarea fișierului.');
  }
}

app.post('/deltarune1Demo/savefile/update', (req, res) => {
  handleSavefileUpdate(req, res, 'filech1_0', 'demo');
});

app.post('/deltarune2Demo/savefile/update', (req, res) => {
  handleSavefileUpdate(req, res, 'filech2_0', 'demo');
});

app.post('/deltarune1/savefile/update', (req, res) => {
  handleSavefileUpdate(req, res, 'filech1_0', 'full');
});

app.post('/deltarune2/savefile/update', (req, res) => {
  handleSavefileUpdate(req, res, 'filech2_0', 'full');
});
app.post('/deltarune3/savefile/update', (req, res) => {
  handleSavefileUpdate(req, res, 'filech3_0', 'full');
});

app.post('/deltarune4/savefile/update', (req, res) => {
  handleSavefileUpdate(req, res, 'filech4_0', 'full');
});

app.use((req, res) => {
  res.status(404).send('Neimplementat.');
});
app.listen(PORT, () => {
  console.log(`Serverul a pornit. Ascultă pe http://localhost:${PORT}/`);
});

